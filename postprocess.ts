// Example response
// {
//     "Data": [
//       {
//         "Id": 3413,
//         "Name": "Term 3 - Friday 9.30am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Robyn Gosbell",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": null,
//             "Day": "Tue"
//           },
//           {
//             "Dates": null,
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": [
//               "2021-07-16T09:30:00"
//             ],
//             "Day": "Fri"
//           },
//           {
//             "Dates": null,
//             "Day": "Sat"
//           },
//           {
//             "Dates": null,
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       },
//       {
//         "Id": 3488,
//         "Name": "Term 3 - Saturday 10:30am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Rory Lewis",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": null,
//             "Day": "Tue"
//           },
//           {
//             "Dates": null,
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": null,
//             "Day": "Fri"
//           },
//           {
//             "Dates": [
//               "2021-07-17T10:30:00"
//             ],
//             "Day": "Sat"
//           },
//           {
//             "Dates": null,
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       },
//       {
//         "Id": 3521,
//         "Name": "Term 3 - Sunday 10:00am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Mel Tuangthong",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": null,
//             "Day": "Tue"
//           },
//           {
//             "Dates": null,
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": null,
//             "Day": "Fri"
//           },
//           {
//             "Dates": null,
//             "Day": "Sat"
//           },
//           {
//             "Dates": [
//               "2021-07-18T10:00:00"
//             ],
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       },
//       {
//         "Id": 3334,
//         "Name": "Term 3 - Tuesday 10:30am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Danielle Otter",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": [
//               "2021-07-13T10:30:00"
//             ],
//             "Day": "Tue"
//           },
//           {
//             "Dates": null,
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": null,
//             "Day": "Fri"
//           },
//           {
//             "Dates": null,
//             "Day": "Sat"
//           },
//           {
//             "Dates": null,
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       },
//       {
//         "Id": 3506,
//         "Name": "Term 3 - Tuesday 11:00am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Robyn Gosbell",
//         "Status": "Bookable",
//         "BookingIndicator": {
//           "Indicator": 1,
//           "Limit": 8,
//           "Available": 1
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": [
//               "2021-07-13T11:00:00"
//             ],
//             "Day": "Tue"
//           },
//           {
//             "Dates": null,
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": null,
//             "Day": "Fri"
//           },
//           {
//             "Dates": null,
//             "Day": "Sat"
//           },
//           {
//             "Dates": null,
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       },
//       {
//         "Id": 3359,
//         "Name": "Term 3 - Wednesday 11.00am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Robyn Gosbell",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },
//         "ClassDates": [
//           {
//             "Dates": null,
//             "Day": "Mon"
//           },
//           {
//             "Dates": null,
//             "Day": "Tue"
//           },
//           {
//             "Dates": [
//               "2021-07-14T11:00:00"
//             ],
//             "Day": "Wed"
//           },
//           {
//             "Dates": null,
//             "Day": "Thu"
//           },
//           {
//             "Dates": null,
//             "Day": "Fri"
//           },
//           {
//             "Dates": null,
//             "Day": "Sat"
//           },
//           {
//             "Dates": null,
//             "Day": "Sun"
//           }
//         ],
//         "Durations": [
//           "PT15M",
//           "PT30M"
//         ],
//         "EnrolledUsers": null
//       }
//     ]
//   }

import { readJSON, writeCSV } from 'https://deno.land/x/flat@0.0.11/mod.ts'
import {Octokit} from 'https://cdn.skypack.dev/@octokit/rest';

const octokit = new Octokit({
    auth: Deno.env.get('GH_TOKEN')
})

const json = await readJSON(Deno.args[0])
const csvFilePath = "classes.csv"

// {
//         "Id": 3359,
//         "Name": "Term 3 - Wednesday 11.00am Babies",
//         "MaxUserNumber": 8,
//         "Level": "Babies",
//         "Trainer": "Robyn Gosbell",
//         "Status": "FullBooked",
//         "BookingIndicator": {
//           "Indicator": 0,
//           "Limit": 8,
//           "Available": 0
//         },

const currentClasses = []
for (const c of json.Data) {
    if (c.Name.includes("Saturday") || c.Name.includes("Sunday")){
        const swimClass = {
            name: c.Name,
            status: c.Status,
            available: c.BookingIndicator.Available,
            limit: c.BookingIndicator.Limit,
        }
        currentClasses.push(swimClass)

        if (swimClass.available > 0) {
            await octokit.request("POST /repos/dalanmiller/baby-swim-flat/issues", {
                owner: 'dalanmiller',
                repo: 'baby-swim-flat',
                title: `Class available ${swimClass.name}`,
                body: `
# ${swimClass.name}
status: ${swimClass.status}
available: ${swimClass.available}
limit: ${swimClass.limit}

https://yarraleisure.perfectgym.com.au/clientportal2/?saquwjj4kvg5rhji23pg24fh4e=mxa3seq5jbe75bguags2gsr3ye#/Groups/3?ageLimitId=3&vacancies=1
`
            })
        }
    }
}



await writeCSV(csvFilePath, currentClasses) 